on:
    workflow_call:
    push:
#    pull_request:
#        branches:
#            - main
#        types: [closed]
jobs:
    setup-shopware:
        name: Setup Shopware
        runs-on: ubuntu-latest

        strategy:
            matrix:
                versions:
                    -   shopware: '5.2'
                        php: '5.6'
                        mysql: '5.7'
                        consentManager: '5.2.11-5.2.27'

                    -   shopware: '5.3'
                        php: '5.6'
                        mysql: '5.7'
                        consentManager: '5.3.5-5.3.7'

                    -   shopware: '5.4'
                        php: '5.6'
                        mysql: '5.7'
                        consentManager: '5.4.6'

                    -   shopware: '5.5'
                        php: '7.1'
                        mysql: '5.7'
                        consentManager: '5.5.0-5.5.10'

                    -   shopware: '5.6'
                        php: '7.2'
                        mysql: '5.7'
                        consentManager: 'none'

                    -   shopware: '5.7'
                        php: '7.4'
                        mysql: '8.0'
                        consentManager: 'none'

                    -   shopware: '5.7'
                        php: '8.0'
                        mysql: '8.0'
                        consentManager: 'none'

                    -   shopware: '5.7'
                        php: '8.1'
                        mysql: '8.0'
                        consentManager: 'none'

                    -   shopware: '5.7'
                        php: '8.2'
                        mysql: '8.0'
                        consentManager: 'none'

        steps:
            -   uses: actions/checkout@v3
            -   uses: actions/setup-node@v3
                with:
                    node-version: current

            -   name: Login to GitHub Container Registry
                uses: docker/login-action@v2
                with:
                    registry: ghcr.io
                    username: ${{ github.actor }}
                    password: ${{ github.token }}

            -   name: Install dependencies
                run: npm install

            -   name: Create base image
                run: make running:shopware_${{ matrix.versions.shopware }}_${{ matrix.versions.mysql }}_${{ matrix.versions.php }}

            -   name: Push base image
                run: docker push ghcr.io/shopware5/docker-images-testing/running:shopware_${{ matrix.versions.shopware }}_${{ matrix.versions.mysql }}_${{ matrix.versions.php }}

            -   name: Create allInOne Image
                run: make install:shopware_${{ matrix.versions.shopware }}_${{ matrix.versions.mysql }}_${{ matrix.versions.php }}_${{ matrix.versions.consentManager }}

            -   name: Push allInOne Image
                run: docker push ghcr.io/shopware5/docker-images-testing/install:shopware_${{ matrix.versions.shopware }}_${{ matrix.versions.mysql }}_${{ matrix.versions.php }}_${{ matrix.versions.consentManager }}

